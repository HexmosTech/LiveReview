# Standardize Endpoint Configuration

```
# LiveReview Environment Configuration
# Generated by lrops.sh installer with two-mode deployment system

# Database Configuration
DB_PASSWORD=ZPtLmXCCV3ra671v8F2rUruIO06j6Ws
DATABASE_URL=postgres://livereview:ZPtLmXCCV3ra671v8F2rUruIO06j6Ws@livereview-db:5432/livereview?sslmode=disable

# Security Configuration
JWT_SECRET=7454f62690b594477964a0e5f035ecaeeb43e8a51d114ef1de7fa33e24a45c11

# Application Configuration
LIVEREVIEW_VERSION=0.0.4
LOG_LEVEL=info

# Frontend API Configuration
# These variables tell the frontend where to find the backend API
# Set automatically by lrops.sh based on deployment mode
# LIVEREVIEW_API_URL=http://localhost:8888 (demo) or http://localhost/api (production)
# VITE_API_URL=http://localhost:8888 (demo) or http://localhost/api (production)
# REACT_APP_API_URL=http://localhost:8888 (demo) or http://localhost/api (production)
# NEXT_PUBLIC_API_URL=http://localhost:8888 (demo) or http://localhost/api (production)

# Session Configuration (optional)
ACCESS_TOKEN_DURATION_HOURS=8
REFRESH_TOKEN_DURATION_DAYS=30

# AI Integration (optional - configure as needed)
# OPENAI_API_KEY=your_openai_api_key
# GOOGLE_AI_API_KEY=your_google_ai_api_key

# Two-Mode Deployment Configuration
# These variables control demo vs production mode behavior
# Set via lrops.sh during installation - do not modify manually

# LIVEREVIEW_BACKEND_PORT=8888
# LIVEREVIEW_FRONTEND_PORT=8081
# LIVEREVIEW_REVERSE_PROXY=false

# Demo Mode (LIVEREVIEW_REVERSE_PROXY=false):
# - Binds to localhost only (secure local development)
# - Webhooks disabled (manual triggers only)
# - No external access
# - Perfect for testing and development

# Production Mode (LIVEREVIEW_REVERSE_PROXY=true):
# - Binds to 127.0.0.1 (behind reverse proxy)
# - Webhooks enabled (automatic triggers)
# - External access via reverse proxy
# - Requires SSL/TLS setup for security

# For mode switching and configuration help:
# lrops.sh help ssl     # SSL/TLS setup
#
# End of .env template

# Two-Mode Deployment Configuration (auto-configured)
LIVEREVIEW_BACKEND_PORT=8888
LIVEREVIEW_FRONTEND_PORT=8081
LIVEREVIEW_REVERSE_PROXY=false

# API URL Configuration for Frontend
# In demo mode: frontend connects directly to backend port
# In production mode: frontend connects via reverse proxy
LIVEREVIEW_API_URL=http://localhost:8888
VITE_API_URL=http://localhost:8888
REACT_APP_API_URL=http://localhost:8888
NEXT_PUBLIC_API_URL=http://localhost:8888

# Deployment mode: demo
# Demo mode: localhost-only, no webhooks, manual triggers only
# Production mode: reverse proxy, webhooks enabled, external access

# DEMO MODE CONFIGURATION
# - Access: http://localhost:8081
# - API: http://localhost:8888
# - Webhooks: Disabled (manual triggers only)
# - External access: Not configured
#
# To upgrade to production mode:
# 1. Set LIVEREVIEW_REVERSE_PROXY=true
# 2. Restart services: docker compose restart
# 3. Configure reverse proxy (see: lrops.sh help nginx)
```

## Configuration Analysis: Issues and Redundancies

### Major Problems Identified

#### 1. **Massive API URL Redundancy**
```bash
LIVEREVIEW_API_URL=http://localhost:8888
VITE_API_URL=http://localhost:8888
REACT_APP_API_URL=http://localhost:8888
NEXT_PUBLIC_API_URL=http://localhost:8888
```
**Issue**: Four identical variables for different frontend frameworks. Users don't know which one applies to their setup, leading to confusion and maintenance overhead.

#### 2. **Commented vs Active Configuration Confusion**
The file mixes commented examples with active configuration:
```bash
# LIVEREVIEW_API_URL=http://localhost:8888 (demo) or http://localhost/api (production)
# Later...
LIVEREVIEW_API_URL=http://localhost:8888
```
**Issue**: Users might uncomment examples AND have active values, creating conflicts. No clear distinction between documentation and configuration.

#### 3. **Scattered Mode Configuration**
Mode-related settings appear in multiple locations:
- Port configuration section
- Reverse proxy boolean
- Repeated explanations throughout file
**Issue**: No single place to understand or change deployment mode.

#### 4. **Unclear Variable Relationships**
```bash
LIVEREVIEW_BACKEND_PORT=8888
LIVEREVIEW_FRONTEND_PORT=8081
LIVEREVIEW_REVERSE_PROXY=false
```
**Issue**: Users don't understand how these variables interact or when to modify them.

#### 5. **Documentation Pollution**
Extensive comments mixed with configuration values make it hard to:
- Find what needs to be changed
- Distinguish configuration from documentation
- Quickly scan current settings

#### 6. **Inconsistent Naming Conventions**
- `LIVEREVIEW_` prefix vs framework-specific prefixes
- `DB_PASSWORD` vs `DATABASE_URL`
- No clear pattern for variable naming

#### 7. **Multiple Sources of Truth**
Deployment mode controlled by:
- `LIVEREVIEW_REVERSE_PROXY` boolean
- Multiple API URLs that should change together
- Port configurations
- Comments describing mode behavior

#### 8. **No Logical Grouping**
Variables scattered without clear sections, making related settings hard to find.

---

## Proposed Solution: Simplified Configuration Structure

### Design Principles
1. **Single source of truth** for each concept
2. **Minimal required configuration** with smart defaults
3. **Clear separation** of user config from documentation
4. **Logical grouping** of related settings
5. **Consistent naming** conventions

### Improved Configuration Structure

```bash
# LiveReview Configuration
# Version: 0.0.4

#==============================================================================
# DEPLOYMENT MODE (Required - Choose One)
#==============================================================================
# Options: demo | production
DEPLOYMENT_MODE=demo

#==============================================================================
# CORE CONFIGURATION (Required)
#==============================================================================
# Database
DATABASE_URL=postgres://livereview:ZPtLmXCCV3ra671v8F2rUruIO06j6Ws@livereview-db:5432/livereview?sslmode=disable

# Security
JWT_SECRET=7454f62690b594477964a0e5f035ecaeeb43e8a51d114ef1de7fa33e24a45c11

#==============================================================================
# OPTIONAL CONFIGURATION
#==============================================================================
# Application
LOG_LEVEL=info
ACCESS_TOKEN_DURATION_HOURS=8
REFRESH_TOKEN_DURATION_DAYS=30

# AI Integration (uncomment and configure as needed)
# OPENAI_API_KEY=your_openai_api_key
# GOOGLE_AI_API_KEY=your_google_ai_api_key

#==============================================================================
# ADVANCED CONFIGURATION (Auto-managed - modify only if needed)
#==============================================================================
# Ports (demo mode defaults)
BACKEND_PORT=8888
FRONTEND_PORT=8081

# API Endpoint (auto-set based on DEPLOYMENT_MODE)
# demo: http://localhost:8888
# production: http://localhost/api
API_URL=http://localhost:8888
```

### Key Improvements

#### 1. **Single Deployment Mode Variable**
- `DEPLOYMENT_MODE=demo|production` replaces multiple variables
- Automatically configures ports, URLs, and proxy settings
- Clear, simple mode switching

#### 2. **Single API URL Variable**
- `API_URL` replaces four framework-specific variables
- Application automatically sets framework-specific variables internally
- Reduces configuration to one line

#### 3. **Clear Section Organization**
- **Deployment Mode**: What users need to choose
- **Core Configuration**: Must be set for basic operation
- **Optional Configuration**: Nice-to-have settings
- **Advanced Configuration**: Usually auto-managed

#### 4. **Consistent Naming**
- All LiveReview variables use consistent patterns
- Clear hierarchy: core concepts get simple names, advanced features get prefixed names

#### 5. **Minimal Required Configuration**
Users only need to set:
- `DEPLOYMENT_MODE`
- `DATABASE_URL` (often auto-generated)
- `JWT_SECRET` (often auto-generated)

#### 6. **Auto-Configuration Logic**
The application would automatically set:
```bash
# When DEPLOYMENT_MODE=demo:
API_URL=http://localhost:${BACKEND_PORT}
REVERSE_PROXY=false
BIND_ADDRESS=localhost

# When DEPLOYMENT_MODE=production:
API_URL=http://localhost/api
REVERSE_PROXY=true
BIND_ADDRESS=127.0.0.1
```

### Migration Strategy
1. **Backward Compatibility**: Support old variable names during transition
2. **Auto-Migration**: Script to convert old config to new format
3. **Validation**: Check for conflicting old/new variables
4. **Documentation**: Clear migration guide for existing users

---

## Implementation Analysis: Files That Need Modification

### Critical Files Requiring Changes

#### 1. **Primary Configuration Generator: `lrops.sh`**
**Current Issues:**
- Lines 1000-1002: Hardcoded variable generation
- Lines 1263-1273: Duplicate API URL generation logic  
- Lines 3135-3137: Docker compose template with redundant variables
- Lines 3192-3194: .env template with commented duplicates

**Required Changes:**
```bash
# Replace this block (lines 1000-1002):
LIVEREVIEW_BACKEND_PORT=8888
LIVEREVIEW_FRONTEND_PORT=8081
LIVEREVIEW_REVERSE_PROXY=false

# With simplified version:
DEPLOYMENT_MODE=demo
BACKEND_PORT=8888
FRONTEND_PORT=8081
API_URL=http://localhost:8888
```

**Auto-configuration logic needed:**
- Function to set API_URL based on DEPLOYMENT_MODE
- Remove manual API URL generation (lines 1263-1273)
- Simplify Docker environment generation

#### 2. **Backend Port Configuration: `cmd/api.go`**
**Current Code (lines 75-78):**
```go
if envPort := os.Getenv("LIVEREVIEW_BACKEND_PORT"); envPort != "" {
    if parsedPort, err := strconv.Atoi(envPort); err == nil {
        port = parsedPort
        fmt.Printf("Using backend port from LIVEREVIEW_BACKEND_PORT: %d\n", port)
```

**Required Changes:**
```go
// Support both old and new variable names during transition
if envPort := os.Getenv("BACKEND_PORT"); envPort != "" {
    // New simplified variable
} else if envPort := os.Getenv("LIVEREVIEW_BACKEND_PORT"); envPort != "" {
    // Legacy support
}
```

#### 3. **Frontend Port Configuration: `cmd/ui.go`**
**Current Code (lines 46-49 & 57-58):**
```go
if envPort := os.Getenv("LIVEREVIEW_FRONTEND_PORT"); envPort != "" {
    // ... port parsing logic
if envBackendPort := os.Getenv("LIVEREVIEW_BACKEND_PORT"); envBackendPort != "" {
    // ... backend port detection
```

**Required Changes:**
- Support `FRONTEND_PORT` and `BACKEND_PORT` variables
- Add auto-configuration based on `DEPLOYMENT_MODE`
- Maintain backward compatibility

#### 4. **Frontend API Client: `ui/src/api/apiClient.ts`**
**Current Logic (lines 27-29):**
```typescript
if (window.LIVEREVIEW_CONFIG?.apiUrl) {
    console.log('âœ… Using runtime config apiUrl:', window.LIVEREVIEW_CONFIG.apiUrl);
    return window.LIVEREVIEW_CONFIG.apiUrl;
```

**Required Changes:**
- The runtime injection logic is actually good and doesn't need changes
- But the Go server needs to inject the simplified `API_URL` variable

#### 5. **Docker Compose Configuration: `docker-compose.yml`**
**Current Code (lines 6-7, 15):**
```yaml
- "${LIVEREVIEW_BACKEND_PORT:-8888}:${LIVEREVIEW_BACKEND_PORT:-8888}"
- "${LIVEREVIEW_FRONTEND_PORT:-8081}:${LIVEREVIEW_FRONTEND_PORT:-8081}"
- LIVEREVIEW_API_URL=${LIVEREVIEW_API_URL:-http://localhost:${LIVEREVIEW_BACKEND_PORT:-8888}}
```

**Required Changes:**
```yaml
# Simplified port mapping
- "${BACKEND_PORT:-8888}:${BACKEND_PORT:-8888}"
- "${FRONTEND_PORT:-8081}:${FRONTEND_PORT:-8081}"
# Single API URL variable  
- API_URL=${API_URL:-http://localhost:${BACKEND_PORT:-8888}}
```

#### 6. **Webpack Configuration: `ui/webpack.config.js`**
**Current Code (line 104):**
```javascript
'process.env.REACT_APP_API_URL': JSON.stringify(process.env.REACT_APP_API_URL),
```

**Required Changes:**
```javascript
// Support the unified API_URL variable
'process.env.API_URL': JSON.stringify(process.env.API_URL || process.env.REACT_APP_API_URL),
'process.env.REACT_APP_API_URL': JSON.stringify(process.env.API_URL || process.env.REACT_APP_API_URL),
```

### Implementation Priority

#### Phase 1: Core Configuration Logic
1. **Update `lrops.sh`** to generate simplified config
2. **Add auto-configuration function** that sets dependent variables based on `DEPLOYMENT_MODE`
3. **Create migration script** to convert existing `.env` files

#### Phase 2: Application Support  
1. **Update Go commands** (`cmd/api.go`, `cmd/ui.go`) to support new variables
2. **Update Docker configurations** to use simplified variables
3. **Update frontend build** to support unified API URL

#### Phase 3: Backward Compatibility
1. **Add deprecation warnings** for old variable names
2. **Update documentation** with migration guide
3. **Test migration scenarios**

### Required Functions in `lrops.sh`

#### Auto-Configuration Function
```bash
configure_deployment_mode() {
    local mode="$1"
    
    if [[ "$mode" == "production" ]]; then
        API_URL="http://localhost/api"
        REVERSE_PROXY="true"
        BIND_ADDRESS="127.0.0.1"
    else
        API_URL="http://localhost:${BACKEND_PORT:-8888}"
        REVERSE_PROXY="false" 
        BIND_ADDRESS="localhost"
    fi
    
    # Set all framework-specific variables automatically
    VITE_API_URL="$API_URL"
    REACT_APP_API_URL="$API_URL"
    NEXT_PUBLIC_API_URL="$API_URL"
    LIVEREVIEW_API_URL="$API_URL"  # Legacy support
}
```

#### Migration Function
```bash
migrate_legacy_config() {
    local env_file="$1"
    
    # Convert old variables to new format
    if grep -q "LIVEREVIEW_REVERSE_PROXY=true" "$env_file"; then
        sed -i 's/LIVEREVIEW_REVERSE_PROXY=.*/DEPLOYMENT_MODE=production/' "$env_file"
    else
        sed -i 's/LIVEREVIEW_REVERSE_PROXY=.*/DEPLOYMENT_MODE=demo/' "$env_file"
    fi
    
    # Add new unified variables
    # Remove old redundant variables
}
```

### Testing Strategy
1. **Test demo mode** with new configuration
2. **Test production mode** with new configuration  
3. **Test migration** from old to new format
4. **Test backward compatibility** with old variable names
5. **Test Docker compose** with new variables